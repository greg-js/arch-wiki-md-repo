Ссылки по теме

*   [Файловые системы](/index.php/%D0%A4%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2%D1%8B%D0%B5_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B "Файловые системы")

**Состояние перевода:** На этой странице представлен перевод статьи [XFS](/index.php/XFS "XFS"). Дата последней синхронизации: 14 октября 2019\. Вы можете [помочь](/index.php/ArchWiki_Translation_Team_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "ArchWiki Translation Team (Русский)") синхронизировать перевод, если в английской версии произошли [изменения](https://wiki.archlinux.org/index.php?title=XFS&diff=0&oldid=585648).

XFS — высокопроизводительная журналируемая файловая система, созданная Silicon Graphics, Inc. XFS особенно хорошо справляется с параллельным вводом-выводом благодаря структуре на основе заголовков для групп (allocation groups), что обеспечивает исключительную масштабируемость потоков ввода-вывода, пропускной способности файловой системы, размера файлов и файловой системы при работе с несколькими устройствами хранения.

<input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none">

## Contents

<label class="toctogglelabel" for="toctogglecheckbox"></label>

*   [1 Установка](#Установка)
*   [2 Повреждение данных](#Повреждение_данных)
    *   [2.1 Восстановление файловой системы XFS](#Восстановление_файловой_системы_XFS)
    *   [2.2 Проверка метаданных "на лету" (scrub)](#Проверка_метаданных_"на_лету"_(scrub))
*   [3 Целостность](#Целостность)
*   [4 Производительность](#Производительность)
    *   [4.1 Размер и ширина полосы (stripe)](#Размер_и_ширина_полосы_(stripe))
    *   [4.2 Время доступа](#Время_доступа)
    *   [4.3 Дефрагментация](#Дефрагментация)
        *   [4.3.1 Проверка уровня фрагментации](#Проверка_уровня_фрагментации)
        *   [4.3.2 Выполнение дефрагментации](#Выполнение_дефрагментации)
    *   [4.4 B-дерево со свободными inode-ами](#B-дерево_со_свободными_inode-ами)
    *   [4.5 Внешний журнал XFS](#Внешний_журнал_XFS)
    *   [4.6 Интервал синхронизации](#Интервал_синхронизации)
*   [5 Решение проблем](#Решение_проблем)
    *   [5.1 Квота корневой файловой системы](#Квота_корневой_файловой_системы)
    *   [5.2 xfs_scrub_all отказывается работать, если пользователь "nobody" не может получить доступ к точке монтирования](#xfs_scrub_all_отказывается_работать,_если_пользователь_"nobody"_не_может_получить_доступ_к_точке_монтирования)
*   [6 Смотрите также](#Смотрите_также)

## Установка

[Установите](/index.php/%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%B8%D1%82%D0%B5 "Установите") пакет [xfsprogs](https://www.archlinux.org/packages/?name=xfsprogs) для получения утилит XFS в пространстве пользователя. Данный пакет содержит средства, необходимые для управления файловой системой XFS.

## Повреждение данных

В случае повреждения данных по какой-либо причине придётся восстанавливать файловую систему вручную.

### Восстановление файловой системы XFS

Сначала размонтируйте файловую систему XFS.

```
# umount /dev/sda3

```

После размонтирования запустите утилиту [xfs_repair(8)](https://jlk.fjfi.cvut.cz/arch/manpages/man/xfs_repair.8).

```
# xfs_repair -v /dev/sda3

```

### Проверка метаданных "на лету" (scrub)

**Важно:** Эта программа является ЭКСПЕРИМЕНТАЛЬНОЙ, соответственно, её поведение и интерфейс могут измениться в любое время, см. [xfs_scrub(8)](https://jlk.fjfi.cvut.cz/arch/manpages/man/xfs_scrub.8).

`xfs_scrub` запрашивает ядро очистить (scrub) все объекты метаданных в XFS.Записи метаданных сканируются на очевидно ошибочные значения, после чего перекрёстно ссылаются на остальные метаданные. Это делается для того, чтобы иметь достаточно уверенности в целостности всей файловой системы, анализируя отдельные записи метаданных на фоне остальных метаданных в файловой системе. Повреждённые метаданные можно восстановить из других метаданных при наличии неповреждённых избыточных структур данных.

[Включите](/index.php/%D0%92%D0%BA%D0%BB%D1%8E%D1%87%D0%B8%D1%82%D0%B5 "Включите") и [запустите](/index.php/%D0%97%D0%B0%D0%BF%D1%83%D1%81%D1%82%D0%B8%D1%82%D0%B5 "Запустите") `xfs_scrub_all.timer` для периодической проверки метаданных всех файловых систем XFS "на лету".

**Примечание:** Для удобства, можно [отредактировать](/index.php/Systemd_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)#Редактирование_предоставленных_пакетами_файлов_юнитов "Systemd (Русский)") `xfs_scrub_all.timer`: таймер выполняется каждое воскресенье в 3:10 и [сразу же запускается](/index.php/Systemd/Timers#Realtime_timer "Systemd/Timers"), если последний запуск был пропущен (например, так как система была выключена).

## Целостность

В [xfsprogs](https://www.archlinux.org/packages/?name=xfsprogs) 3.2.0 появился новый дисковый (on-disk) формат (v5), включающий в себя схему контрольных сумм метаданных — [Self-Describing Metadata](https://www.kernel.org/doc/Documentation/filesystems/xfs-self-describing-metadata.txt). Она основывается на CRC32 и обеспечивает, к примеру, дополнительную защиту от повреждения метаданных при непредвиденном отключении электропитания. Контрольная сумма включена по умолчанию начиная с [xfsprogs](https://www.archlinux.org/packages/?name=xfsprogs) 3.2.3\. Если требуется монтируемый для чтения-записи раздел XFS на более старом ядре, данная функция легко отключается с помощью параметра `-m crc=0` при вызове [mkfs.xfs(8)](https://jlk.fjfi.cvut.cz/arch/manpages/man/mkfs.xfs.8).

```
# mkfs.xfs -m crc=0 /dev/*необходимый_раздел*

```

Дисковый (on-disk) формат XFS v5 считается стабильным для промышленной эксплуатации начиная с ядра Linux 3.15.

**Примечание:** В отличие от [Btrfs](/index.php/Btrfs_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "Btrfs (Русский)") и [ZFS](/index.php/ZFS "ZFS"), контрольная сумма CRC32 применяется только к метаданным, а не к фактическим данным.

## Производительность

Просто создайте файловую систему XFS, чтобы достичь оптимальной скорости:

```
# mkfs.xfs /dev/*необходимый_раздел*

```

В XFS [все улучшения включены по умолчанию](http://xfs.org/index.php/XFS_FAQ#Q:_I_want_to_tune_my_XFS_filesystems_for_.3Csomething.3E).

Смотрите также [xfs(5)](https://jlk.fjfi.cvut.cz/arch/manpages/man/xfs.5) для получения информации о доступных параметрах монтирования.

**Совет:** При использовании XFS на устройствах с [RAID](/index.php/RAID "RAID"), улучшить производительность можно с помощью `largeio`, `swalloc`, увеличенными значениями `logbsize`, `allocsize` и так далее. В следующих статьях предоставлена дополнительная информация об этих флагах:

*   [https://www.beegfs.io/wiki/StorageServerTuning](https://www.beegfs.io/wiki/StorageServerTuning)
*   [https://help.marklogic.com/Knowledgebase/Article/View/505/0/recommended-xfs-settings-for-marklogic-server](https://help.marklogic.com/Knowledgebase/Article/View/505/0/recommended-xfs-settings-for-marklogic-server)

### Размер и ширина полосы (stripe)

Если файловая система будет использоваться на чередующемся RAID-массиве, можно значительно повысить скорость, указав размер полосы (stripe) в команде [mkfs.xfs(8)](https://jlk.fjfi.cvut.cz/arch/manpages/man/mkfs.xfs.8).

XFS иногда определяет "геометрию" программного RAID-массива, но если она изменяется или используется аппаратный RAID, то см. статью "[How to calculate the correct sunit,swidth values for optimal performance](http://xfs.org/index.php/XFS_FAQ#Q:_How_to_calculate_the_correct_sunit.2Cswidth_values_for_optimal_performance)".

### Время доступа

В некоторых файловых системах можно повысить производительность, добавив параметр монтирования `noatime` в файле `/etc/fstab`. Для XFS стандартным поведением atime является `relatime`, которое почти не имеет накладных расходов по сравнению с noatime, но при этом сохраняет нормальные значения atime. Все файловые системы Linux теперь используют это в качестве значения по умолчанию (примерно с версии 2.6.30), но XFS использует relatime-поведение с 2006 года, поэтому нет никакой необходимости использовать noatime по соображениям производительности.

Кроме того, `noatime` подразумевает `nodiratime`, поэтому нет необходимости указывать **nodiratime** при уже заданном **noatime**.

### Дефрагментация

Хотя основанная на экстентах природа XFS и используемая стратегия отложенного размещения значительно повышают устойчивость файловой системы к проблемам фрагментации, XFS предоставляет утилиту *xfs_fsr* (сокращение от "реорганизатора файловой системы XFS") для дефрагменентации файлов на смонтированной и активной файловой системе XFS. Также полезно периодически проверять фрагментацию XFS.

[xfs_fsr(8)](https://jlk.fjfi.cvut.cz/arch/manpages/man/xfs_fsr.8) улучшает организацию смонтированных файловых систем. Алгоритм реорганизации работает с одним файлом за раз, сжимая или улучшая размещение экстентов файла (последовательных блоков данных файла).

#### Проверка уровня фрагментации

Проверить уровень фрагментации в данный момент можно следующей командой:

```
# xfs_db -c frag -r /dev/sda3

```

#### Выполнение дефрагментации

Используйте команду [xfs_fsr(8)](https://jlk.fjfi.cvut.cz/arch/manpages/man/xfs_fsr.8), чтобы начать дефрагментацию:

```
# xfs_fsr /dev/sda3

```

### B-дерево со свободными inode-ами

Начиная с Linux 3.16, в XFS появилось B-дерево для отслеживания свободных inode, что равноценно существующему B-дереву для распределения индексных дескрипторов, за исключением того, что отслеживаются inode-блоки по крайней мере с одним свободным inode. Это делается для того, чтобы ускорить поиск свободных inode-кластеров при распределении inode. Также это повышает производительность старых файловых систем, например, спустя месяцы или годы после добавления и удаления миллионов файлов на файловой системе. Использование этой функции не влияет на общий уровень надёжности ФС или возможность восстановления.

Данная функция основывается на новом дисковом (on-disk) формате XFS v5, который считается стабильным для промышленной эксплуатации начиная с ядра Linux 3.15\. Она не изменяет существующие дисковые структуры, но добавляет новую, которая должна оставаться целостной в B-дереве для отслеживания свободных inode. По этой же причине более старые версии ядра монтируют файловые системы с B-деревом свободных inode только в режиме для чтения.

Также данная функция включена по умолчанию начиная с xfsprogs 3.2.3\. Если требуется возможность записи на файловую систему при использовании более старого ядра, отключите её с помощью параметра `finobt=0` при форматировании XFS-раздела. `crc=0` указывается вместе с предыдущим параметром.

```
# mkfs.xfs -m crc=0,finobt=0 /dev/*необходимый_раздел*

```

или короче (`finobt` зависит от `crc`)

```
# mkfs.xfs -m crc=0 /dev/*необходимый_раздел*

```

### Внешний журнал XFS

Использование внешнего лога (журнала метаданных), например, на [SSD (Русский)](/index.php/SSD_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "SSD (Русский)"), может улучшить производительность [[1]](https://docs.oracle.com/cd/E37670_01/E37355/html/ol_extjnl_xfs.html). См. [mkfs.xfs(8)](https://jlk.fjfi.cvut.cz/arch/manpages/man/mkfs.xfs.8) для получения информации о параметре `logdev`.

**Важно:** Учтите, что использование флеш-памяти для этих целей может ускорить износ диска. См. раздел [Improving performance#Reduce disk reads/writes](/index.php/Improving_performance#Reduce_disk_reads/writes "Improving performance") для получения информации о износе SSD.

Укажите опцию `-l logdev=device,size=size` команде `mkfs.xfs` для резервации внешнего журнала определённого размера при создании файловой системы XFS. Если пропустить параметр `size`, размер журнала будет зависеть от размера ФС. Укажите опцию `-o logdev=device` команде [mount](/index.php/File_systems_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)#Монтирование_файловой_системы "File systems (Русский)") для монтирования XFS с использованием внешнего журнала.

### Интервал синхронизации

В XFS существует отдельная переменная [sysctl](/index.php/Sysctl "Sysctl") для настройки [интервала обратной записи](/index.php/Improving_performance#Writeback_interval_and_buffer_size "Improving performance") (writeback interval). По умолчанию в Arch используется значение "3000". Возможно также задать и большее значение, однако стоит учитывать, что слишком большое значение может привести к потери данных в некоторых случаях:

 `/etc/sysctl.d/20-xfs-sync-interval.conf`  `fs.xfs.xfssyncd_centisecs = 10000` 

## Решение проблем

### Квота корневой файловой системы

Параметры монтирования XFS (`uquota`, `gquota`, `prjquota` и т.д.) не выполняются во время повторного монтирования файловой системы. Чтобы включить квоту корневой файловой системы, параметр монтирования должен быть передан initramfs как [параметр ядра](/index.php/%D0%9F%D0%B0%D1%80%D0%B0%D0%BC%D0%B5%D1%82%D1%80_%D1%8F%D0%B4%D1%80%D0%B0 "Параметр ядра") `rootflags=`. Впоследствии его не следует указывать среди параметров монтирования в `/etc/fstab` для корневой (`/`) файловой системы.

**Примечание:** Существуют некоторые различия между квотой XFS и стандартной [дисковой квотой](/index.php/Disk_quota "Disk quota") Linux, также стоит прочитать статью [http://inai.de/linux/adm_quota](http://inai.de/linux/adm_quota).

### xfs_scrub_all отказывается работать, если пользователь "nobody" не может получить доступ к точке монтирования

При запуске `xfs_scrub_all` также запускается `xfs_scrub@.service` для каждой примонтированной файловой системы XFS. Данная служба запускается от пользователя `nobody` и соответственно, если `nobody` не может перейти в директорию, команда завершится со следующей ошибкой:

```
xfs_scrub@*точка_монтирования*.service: Changing to the requested working directory failed: Permission denied
xfs_scrub@*точка_монтирования*.service: Failed at step CHDIR spawning /usr/bin/xfs_scrub: Permission denied
xfs_scrub@*точка_монтирования*.service: Main process exited, code=exited, status=200/CHDIR

```

Чтобы разрешить запуск службы, измените [разрешения](/index.php/File_permissions_and_attributes "File permissions and attributes") точки монтирования таким образом, чтобы у пользователя `nobody` были права на выполнение.

## Смотрите также

*   [XFS FAQ](http://xfs.org/index.php/XFS_FAQ)
*   [Improving Metadata Performance By Reducing Journal Overhead](http://xfs.org/index.php/Improving_Metadata_Performance_By_Reducing_Journal_Overhead)
*   [Статья о XFS на Википедии](https://en.wikipedia.org/wiki/ru:XFS "wikipedia:ru:XFS")