**Состояние перевода:** На этой странице представлен перевод статьи [Migrating between architectures](/index.php/Migrating_between_architectures "Migrating between architectures"). Дата последней синхронизации: 1 декабря 2018\. Вы можете [помочь](/index.php/ArchWiki_Translation_Team_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "ArchWiki Translation Team (Русский)") синхронизировать перевод, если в английской версии произошли [изменения](https://wiki.archlinux.org/index.php?title=Migrating_between_architectures&diff=0&oldid=532602).

На этой странице описаны два возможных способа миграции установленных систем с 64-разрядных (32-разрядных) на x86_64 (64-разрядные) архитектуры. Методы избегают «полной» переустановки (т. е. очистки жесткого диска). Один метод использует liveCD, другой изменяет систему изнутри.

**Примечание:** Технически этот процесс по-прежнему включает «переустановку», поскольку каждый пакет в системе должен быть заменен. Эти методы просто пытаются сохранить как можно больше из вашей существующей системы.

**Важно:** Если не указано явно, все эти методы «не проверены» и могут нанести непоправимый урон вашей системе. Продолжайте на свой страх и риск.

## Contents

*   [1 Общая подготовка](#Общая_подготовка)
    *   [1.1 Проверить 64-битную архитектуру](#Проверить_64-битную_архитектуру)
    *   [1.2 Дисковое пространство](#Дисковое_пространство)
    *   [1.3 Источник питания](#Источник_питания)
    *   [1.4 Пакеты резервных копий](#Пакеты_резервных_копий)
*   [2 Метод 1: с использованием Arch LiveCD](#Метод_1:_с_использованием_Arch_LiveCD)
*   [3 Метод 2: из работающей системы](#Метод_2:_из_работающей_системы)
    *   [3.1 Подготовка пакетов](#Подготовка_пакетов)
        *   [3.1.1 Кеширование старых пакетов](#Кеширование_старых_пакетов)
        *   [3.1.2 Установка busybox](#Установка_busybox)
        *   [3.1.3 Изменение архитектуры Pacman](#Изменение_архитектуры_Pacman)
        *   [3.1.4 Скачайте новые пакеты](#Скачайте_новые_пакеты)
    *   [3.2 Установка пакетов](#Установка_пакетов)
        *   [3.2.1 Установка ядра (64-bit)](#Установка_ядра_(64-bit))
        *   [3.2.2 Установка lib32-glibc](#Установка_lib32-glibc)
        *   [3.2.3 Перезагрузка](#Перезагрузка)
        *   [3.2.4 Переключение в консольный терминал](#Переключение_в_консольный_терминал)
        *   [3.2.5 Установка Pacman](#Установка_Pacman)
        *   [3.2.6 Установка остальных пакетов](#Установка_остальных_пакетов)
*   [4 Очистка](#Очистка)
    *   [4.1 Флаги компиляции Makepkg](#Флаги_компиляции_Makepkg)
*   [5 Устранение проблем](#Устранение_проблем)
    *   [5.1 Busybox](#Busybox)
    *   [5.2 Lib32-glibc](#Lib32-glibc)
    *   [5.3 KDE не запускается после миграции с 32-bit на 64-bit](#KDE_не_запускается_после_миграции_с_32-bit_на_64-bit)
    *   [5.4 Проблемы Mutt при включенном кеше](#Проблемы_Mutt_при_включенном_кеше)
*   [6 Смотрите также](#Смотрите_также)

## Общая подготовка

### Проверить 64-битную архитектуру

Для запуска 64-разрядного программного обеспечения у вас должен быть 64-разрядный процессор. Большинство современных процессоров способны запускать 64-битное программное обеспечение. Вы можете проверить свой процессор с помощью следующей команды:

```
 # grep --color -w lm /proc/cpuinfo

```

Для процессоров, поддерживающих x86_64, это вернет `lm` flag (“long mode”). Остерегайтесь того, что 'lahf_lm' - это другой флаг и не указывает на 64-битные возможности.

### Дисковое пространство

Вы должны быть готовы к увеличению размера `/var/cache/pacman/pkg` примерно в два раза. Предполагается, что в кеше находятся только установленные в данный момент, как будто “pacman -Sc” (clean) был недавно запущен. Увеличение дискового пространства связано с дублированием каждого пакета для версии i686 и x86_64.

Если у вас недостаточно диска, используйте [GParted](/index.php/GParted "GParted"), чтобы изменить размер соответствующего раздела или установить другой раздел в `/var/cache/pacman`.

Не удаляйте пакеты старой архитектуры из кеша, пока система не будет полностью работать в новой архитектуре. Снятие пакетов слишком рано может оставить вас неспособными отступить и вернуть изменения.

### Источник питания

Миграция может занять значительное количество времени, и было бы неудобно прерывать процесс. Вы должны планировать как минимум час, в зависимости от количества и размера установленных пакетов и скорости интернет-соединения (хотя вы можете загрузить все, прежде чем запускать критическую часть). Убедитесь, что вы подключены к стабильному источнику питания, предпочтительно с какой-либо отказоустойчивостью или резервным аккумулятором.

### Пакеты резервных копий

Если миграция завершилась неудачно, есть пакеты, которые могут помочь разобраться в ситуации, но они должны быть установлены до переноса основных пакетов. Подробнее об использовании их в разделе [#Устранение проблем](#Устранение_проблем) ниже.

Один пакет [busybox](https://www.archlinux.org/packages/?name=busybox), который можно использовать для возврата изменений. Он статически связан и не зависит от каких-либо библиотек. Должна быть установлена 32-разрядная версия (i686).

Другой пакет [lib32-glibc](https://www.archlinux.org/packages/?name=lib32-glibc), из [multilib](/index.php/Multilib "Multilib") x86_64 репозитория, может пригодиться только при миграции с 32 бит. Вы можете безопасно пропустить этот пакет, а для запуска 32-битных программ явно вызывать `/lib/ld-linux.so.2`.

## Метод 1: с использованием Arch LiveCD

1.  [Скачайте](https://www.archlinux.org/download/) и запишите свежий образ Arch Linux ISO.
2.  Загрузите Arch LiveCD в режиме x86_64.
3.  Настройте доступ к сети.
4.  Примонтируйте текущую установку. Например: `mount /dev/sda1 /mnt`.
5.  Отредактируйте репозитории LiveCD `/etc/pacman.conf` для соответствия текущим репозиториям `/mnt/etc/pacman.conf`.
6.  Обновите базу pacman и очистите кэш при помощи команд:

```
 # pacman --root /mnt -Syy
 # pacman --root /mnt -Scc

```

	6\. Сначала попробуйте переустановить только группу [base](https://www.archlinux.org/groups/x86_64/base/), затем каждый пакет, при установке которого возникла ошибка. Найти эти пакеты можно при помощи `pacman --root /mnt -Qo <error file>`. Затем повторяйте установку группы [base](https://www.archlinux.org/groups/x86_64/base/) до тех пор, пока установка не закончится без ошибок.

```
 # pacman --root /mnt -S base

```

	7\. Получить список всех установленных пакетов и переустановить их можно при помощи команды:

```
 # pacman --root /mnt -Qnq | pacman --root /mnt -S -

```

	8\. Команду следует запускать дважды, потому что при первом запуске многие пакеты не смогут выполнить пост-установочные скрипты из-за неверной архитектуры. К примеру, sed, grep, perl и другие. Либо вы можете записать пакеты, установка которых завершилась ошибкой, а затем вернуться к ним после окончания миграции и переустановить. Если же при установке закончилось свободное место, вы можете отфильтровать пакеты по алфавиту и обновлять их группами. Например, сначала `...| grep '^[a-k]' |...`, затем `'^l'` и в конце `'^[m-z]'`. Также не забывайте запускать после каждой установки `pacman --root /mnt -Scc` для освобождения места. Или, так как весь пакет загружается в LiveCD ramfs, вы также можете смонтировать этот раздел или создать символьную ссылку на `/var/cache/pacman/pkg`:

```
 `ln -s /mnt/var/cache/pacman/pkg /var/cache/pacman/pkg`

```

	9\. И в конце запустите

```
 # arch-chroot /mnt 
 # mkinitcpio -p linux

```

	10\. Также обратите внимание на загрузчик, который тоже может потребовать миграции. К примеру:

```
 # grub-install --recheck /dev/sda

```

	11\. После перезагрузки в новую 64-битную систему отредактируйте `/etc/makepkg.conf.pacnew` и переместите в `/etc/makepkg.conf` для подготовки к миграции на новую архитектуру сторонних пакетов, включая AUR. Затем их необходимо пересобрать.

	Перед пересборкой может потребоваться удаление orphaned пакетов. Для поиска 32-битных пакетов воспользуйтесь:

```
 $ LC_ALL=C pacman -Qo `find /usr/bin -type f -exec bash -c 'file "{}" | grep 32-bit' \; | cut -d':' -f1` | cut -d' ' -f5 | sort | uniq | tee list

```

## Метод 2: из работающей системы

Убедитесь, что ваша система полностью обновлена и работоспособна.

```
# pacman -Syu

```

### Подготовка пакетов

#### Кеширование старых пакетов

**Примечание:** Если вы устанавливали пакеты без поддержки новой архитектуры из [AUR](/index.php/AUR "AUR") или сторонних репозиториев, pacman уведомит, если не сможет найти замену. Запишите их, после миграции переустановите, а затем удалите при помощи `pacman -Rsn package_name`.

Если у вас нет в кэше всех установленных пакетов, загрузите их (для старой архитектуры) для возможности восстановления.

```
# pacman -Qqn | pacman -Sw -

```

или используйте bacman из [pacman](https://www.archlinux.org/packages/?name=pacman).

#### Установка busybox

Если вы мигрируете с 32 бит на 64 бита, самое время установить 32-битный [busybox](https://www.archlinux.org/packages/?name=busybox)

```
# pacman -S busybox

```

#### Изменение архитектуры Pacman

Отредактируйте `/etc/pacman.conf` и измените *Architecture* с `auto` на `x86_64`.

Убедитесь, что в списках серверов в `/etc/pacman.conf` и `/etc/pacman.d/mirrorlist` используется `$arch` вместо принудительно заданных `i686` или `x86_64`. Затем принудительно синхронизируйте Pacman с репозиториями:

```
# pacman -Syy                     # принудительная синхронизация с новой архитектурой

```

#### Скачайте новые пакеты

Скачайте для всех установленных пакетов версию для новой архитектуры:

```
# pacman -Sw $(pacman -Qqn|sed '/^lib32-/ d')  # скачать пакеты для новой архитектуры

```

**Важно:** Не устанавливайте сразу пакет*lib32-glibc*. После *ldconfig*, при установке *linux*, созданный образ будет включать библиотеки вида *librt.so* в `/usr/lib32`, которые при загрузке не будут найдены и процесс загрузки прервется.

### Установка пакетов

#### Установка ядра (64-bit)

Обновить ядро до 64-битного (x86_64) просто и безопасно: 32-битные и 64-битные приложения работают с 64-битным ядром одинаково хорошо.

Установите пакет [linux](https://www.archlinux.org/packages/?name=linux).

```
# pacman -S linux

```

#### Установка lib32-glibc

Установите [lib32-glibc](https://www.archlinux.org/packages/?name=lib32-glibc) на случай возникновения непредвиденных неполадок, а также 64-разрядную версию библиотеки [glibc](https://www.archlinux.org/packages/?name=glibc). Для этого может потребоваться включить репозиторий [multilib](/index.php/Multilib "Multilib") в `/etc/pacman.conf`, если вы еще не сделали это ранее.

```
# pacman -S glibc lib32-glibc

```

**Важно:** Если вы не установите 64-разрядную версию glibc вместе с lib32-glibc в то же время, то lib32-glibc не будет работать. Тем не менее, pacman не предупредит вас об этом, так как 32-разрядный пакет glibc также удовлетворяет все зависимости.

#### Перезагрузка

После перезагрузки убедитесь, что работаете в архитектуре x86_64:

 `$ uname -m` 
```
x86_64

```

#### Переключение в консольный терминал

Для продолжения по возможности переключитесь в текстовую виртуальную консоль (напр. при помощи Ctrl+Alt+F1). Если при использовании первой консоли возникают проблемы, используйте вместо нее вторую (Ctrl-Alt+F2). Псевдо-терминалы вроде SSH должны работать, но в целях предосторожности рекомендуется прямой доступ. В процессе миграции некоторые пакеты будут заменены, что может сказаться на X11 и загрузить систему будет невозможно.

#### Установка Pacman

**Важно:** После запуска обновления pacman и его зависимостей нельзя прерывать процесс! Pacman и все зависимости должны быть установлены одновременно и одной командой.

**Важно:** После выполнения этой команды только Busybox, Bash и Pacman останутся исполняемыми до момента миграции остальных пакетов. При использовании sudo вы должны получить привилегии root перед следующей командой.

Воспользуйтесь pactree для установки Pacman и всех его зависимостей:

```
# pactree -l pacman | pacman -S -

```

В процессе могут возникать ошибки, но они не страшны пока Pacman продолжает работать.

**Важно:** До окончания выполнения команды не перезагружайтесь. Если вы все-таки решитесь перезагрузиться, продолжить установку можно из другого Linux-окружения (например, установочного образа)

#### Установка остальных пакетов

Установите все предварительно скачанные пакеты для новой архитектуры. (Сварите кофе и намажьте пару бутербродов красной икрой, это небыстрый процесс)

```
# pacman -Qqn | pacman -S -

```

Если при установке каких-либо пакетов возникнут проблемы, их необходимо переустановить вручную. Если вам лень, то можно просто перезапускать эту команду до успешного завершения.

После этого этапа миграция будет окончена, можно безопасно перезагузить систему.

Однако если были установлены пакеты из AUR, необходимо их переустановить отдельно. Список можно получить командой:

```
$ pacman -Qqm

```

## Очистка

Теперь можно безопасно удалить **busybox** и *lib32-glibc*.

#### Флаги компиляции Makepkg

При обновлении новая версия `/etc/makepkg.conf` может быть сохранена как `/etc/makepkg.conf.pacnew`. Если это произошло, то необходимо заменить прежнюю версию на новую или отредактировать ее для сборки при помощи [makepkg](/index.php/Makepkg "Makepkg") в будущем.

```
# mv /etc/makepkg.conf /etc/makepkg.conf.backup && mv /etc/makepkg.conf.pacnew /etc/makepkg.conf

```

Неплохо бы было проверить вообще все "new" файлы в `/etc` при помощи:

```
# find /etc/ -type f -name \*.pac\*

```

## Устранение проблем

При замене glibc на версию для новой архитектуры в процессе обновления многие приложения для старой архитектуры могут не запуститься. Проблему можно решить при помощи [busybox](https://www.archlinux.org/packages/?name=busybox) и [lib32-glibc](https://www.archlinux.org/packages/?name=lib32-glibc).

### Busybox

В Arch Busybox статически связан. Он может быть запущен без библиотек и предоставить вам массу команд. Например, для извлечения i686-версии Pacman из пакета в кеше можно воспользоваться:

```
# busybox tar xf /var/cache/pacman/pkg/pacman-3.3.2-1-i686.pkg.tar.gz -C <some folder>

```

### Lib32-glibc

Пример запуска 32-битного `/bin/ls`:

```
# /lib/ld-linux.so.2 /bin/ls

```

### KDE не запускается после миграции с 32-bit на 64-bit

KDE будет падать после перехода с 32-bit на 64-bit из-за некоторых 32-битных пакетов в /var/tmp. Для решения проблемы достаточно удалить все папки с кешем.

```
# rm -rf /var/tmp/kdecache-*

```

### Проблемы Mutt при включенном кеше

Если после завершения миграции [Mutt](/index.php/Mutt "Mutt") зависает на открытии папок, попробуйте переименовать папку с кешем. Если это решит проблему - переименованную папку можно удалить, Mutt сам создаст новую.

## Смотрите также

*   [Migrate installation to new hardware](/index.php/Migrate_installation_to_new_hardware "Migrate installation to new hardware")