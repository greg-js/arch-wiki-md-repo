Ссылки по теме

*   [Создание пакетов](/index.php/%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%BE%D0%B2 "Создание пакетов")
*   [PKGBUILD (Русский)](/index.php/PKGBUILD_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "PKGBUILD (Русский)")
*   [.SRCINFO](/index.php/.SRCINFO ".SRCINFO")
*   [Пользовательский репозиторий Arch](/index.php/%D0%9F%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8C%D1%81%D0%BA%D0%B8%D0%B9_%D1%80%D0%B5%D0%BF%D0%BE%D0%B7%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%B9_Arch "Пользовательский репозиторий Arch")
*   [pacman (Русский)](/index.php/Pacman_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "Pacman (Русский)")
*   [Официальные репозитории](/index.php/%D0%9E%D1%84%D0%B8%D1%86%D0%B8%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5_%D1%80%D0%B5%D0%BF%D0%BE%D0%B7%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%B8 "Официальные репозитории")
*   [Система сборки Arch](/index.php/%D0%A1%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%B0_%D1%81%D0%B1%D0%BE%D1%80%D0%BA%D0%B8_Arch "Система сборки Arch")

**Состояние перевода:** На этой странице представлен перевод статьи [Makepkg](/index.php/Makepkg "Makepkg"). Дата последней синхронизации: 21 декабря 2019\. Вы можете [помочь](/index.php/ArchWiki_Translation_Team_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "ArchWiki Translation Team (Русский)") синхронизировать перевод, если в английской версии произошли [изменения](https://wiki.archlinux.org/index.php?title=Makepkg&diff=0&oldid=588050).

[makepkg](https://projects.archlinux.org/pacman.git/tree/scripts/makepkg.sh.in) — скрипт автоматизации сборки пакетов. Системные требования скрипта включают в себя наличие файла [PKGBUILD](/index.php/PKGBUILD_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "PKGBUILD (Русский)") и UNIX-платформы с поддержкой сборки.

*makepkg* поставляется с пакетом [pacman](https://www.archlinux.org/packages/?name=pacman).

<input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none">

## Contents

<label class="toctogglelabel" for="toctogglecheckbox"></label>

*   [1 Настройка](#Настройка)
    *   [1.1 Информация о создателе пакета](#Информация_о_создателе_пакета)
    *   [1.2 Выходные файлы пакета](#Выходные_файлы_пакета)
    *   [1.3 Проверка подписей](#Проверка_подписей)
*   [2 Использование](#Использование)
*   [3 Советы и рекомендации](#Советы_и_рекомендации)
    *   [3.1 Создание оптимизированных двоичных пакетов](#Создание_оптимизированных_двоичных_пакетов)
    *   [3.2 Сокращение времени компиляции](#Сокращение_времени_компиляции)
        *   [3.2.1 Параллельная компиляция](#Параллельная_компиляция)
        *   [3.2.2 Сборка из файлов в памяти](#Сборка_из_файлов_в_памяти)
        *   [3.2.3 Использование кэша компиляции](#Использование_кэша_компиляции)
    *   [3.3 Вычисление новых контрольных сумм](#Вычисление_новых_контрольных_сумм)
    *   [3.4 Применение других алгоритмов сжатия](#Применение_других_алгоритмов_сжатия)
    *   [3.5 Использование нескольких ядер при сжатии](#Использование_нескольких_ядер_при_сжатии)
    *   [3.6 Вывод списка пакетов по имени создателя](#Вывод_списка_пакетов_по_имени_создателя)
    *   [3.7 Сборка 32-битных пакетов в 64-битной системе](#Сборка_32-битных_пакетов_в_64-битной_системе)
*   [4 Решение проблем](#Решение_проблем)
    *   [4.1 CFLAGS/CXXFLAGS/LDFLAGS в makepkg.conf не работают для пакетов на основе CMake](#CFLAGS/CXXFLAGS/LDFLAGS_в_makepkg.conf_не_работают_для_пакетов_на_основе_CMake)
    *   [4.2 CFLAGS/CXXFLAGS/LDFLAGS в makepkg.conf не работают для пакетов на основе QMake](#CFLAGS/CXXFLAGS/LDFLAGS_в_makepkg.conf_не_работают_для_пакетов_на_основе_QMake)
    *   [4.3 Назначение установочного каталога для пакетов на основе QMAKE](#Назначение_установочного_каталога_для_пакетов_на_основе_QMAKE)
    *   [4.4 WARNING: Package contains reference to $srcdir](#WARNING:_Package_contains_reference_to_$srcdir)
    *   [4.5 Makepkg не может загрузить зависимости через прокси](#Makepkg_не_может_загрузить_зависимости_через_прокси)
        *   [4.5.1 Установите URL прокси-сервера в XferCommand](#Установите_URL_прокси-сервера_в_XferCommand)
        *   [4.5.2 Разблокируйте прокси в файле /etc/sudoers](#Разблокируйте_прокси_в_файле_/etc/sudoers)
    *   [4.6 Makepkg не работает, но make завершается успешно](#Makepkg_не_работает,_но_make_завершается_успешно)
*   [5 Смотрите также](#Смотрите_также)

## Настройка

Обратитесь к [makepkg.conf(5)](https://jlk.fjfi.cvut.cz/arch/manpages/man/makepkg.conf.5), чтобы узнать больше о возможных опциях настройки *makepkg*.

Общесистемные настройки доступны в файле `/etc/makepkg.conf`, пользовательские — в `$XDG_CONFIG_HOME/pacman/makepkg.conf` или `~/.makepkg.conf`. Перед сборкой пакетов рекомендуется проверять настройки.

### Информация о создателе пакета

Каждый пакет обладает метаданными, в которых, помимо прочего, содержится информация о создателе пакета ("packager"). Если этот параметр не задан, то при создании пакета ему присваивается значение по умолчанию — `Unknown Packager`. Однако если компиляцией пакетов занимаются несколько пользователей на одном компьютере или планируется распространять пакет другим пользователям, то имеет смысл указать настоящие контактные данные, задав переменной `PACKAGER` необходимое значение в файле `makepkg.conf`.

Проверить данный параметр в установленном пакете можно следующим образом:

 `$ pacman -Qi *пакет*` 
```
...
Packager       : John Doe <john@doe.com>
...

```

Также задайте значение переменной `GPGKEY` в файле `makepkg.conf` для автоматического создания подписанных пакетов.

### Выходные файлы пакета

По умолчанию *makepkg* создаёт архив пакета в формате tar в рабочем каталоге, а исходный код загружает в каталог `src/`. Расположение целевых каталогов можно переназначить, например, так, чтобы все собранные пакеты хранились в `~/build/packages/`, а все исходные данные — в `~/build/sources/`.

Необходимо задать следующие значения в `makepkg.conf`:

*   `PKGDEST` — каталог хранения итоговых пакетов (с расширением `.pkg.tar.xz`)
*   `SRCDEST` — каталог хранения [исходных](/index.php/PKGBUILD_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)#source "PKGBUILD (Русский)") данных (символические указатели будут размещены в `src/`, если данные указывают на какое-либо другое расположение)
*   `SRCPKGDEST` — каталог хранения итоговых исходных пакетов (с расширением `.src.tar.gz` и собранных с помощью команды `makepkg -S`)

**Совет:** Каталог `PKGDEST` можно очистить, например, командой `paccache -c ~/build/packages/`, как описано в разделе [pacman (Русский)#Очистка кэша пакетов](/index.php/Pacman_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)#Очистка_кэша_пакетов "Pacman (Русский)").

### Проверка подписей

**Примечание:** Реализованная в *makepkg* проверка подписей не использует связки ключей ("keyring") pacman, а полагается исключительно на пользовательские связки. [[1]](http://allanmcrae.com/2015/01/two-pgp-keyrings-for-package-management-in-arch-linux/)

Если файл подписи с расширением *.sig* или *.asc* является частью массива *source* в файле [PKGBUILD](/index.php/PKGBUILD_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "PKGBUILD (Русский)"), то *makepkg* автоматически попытается [проверить](/index.php/GnuPG#Verify_a_signature "GnuPG") его. В случае если пользовательская связка ключей не содержит необходимый для подтверждения сигнатур публичный ключ, то *makepkg* прервёт установку, выведя сообщение о невозможности проверки PGP-ключа.

Если необходимый публичный ключ отсутствует, то [PKGBUILD](/index.php/PKGBUILD_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "PKGBUILD (Русский)"), скорее всего, содержит пункт [validpgpkeys](/index.php/PKGBUILD#validpgpkeys "PKGBUILD") с идентификаторами ключей. Ключи можно [импортировать](/index.php/GnuPG_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)#Импортирование_ключей "GnuPG (Русский)") вручную или же найти их [на сервере ключей](/index.php/GnuPG#Use_a_keyserver "GnuPG") и импортировать оттуда.

## Использование

Для корректной работы *makepkg* необходимо предварительно [установить](/index.php/%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%B8%D1%82%D1%8C "Установить") группу пакетов [base-devel](https://www.archlinux.org/groups/x86_64/base-devel/). Пакеты из этой группы не обязательно указывать в качестве зависимосимостей для сборки (*makedepends*) в файлах [PKGBUILD](/index.php/PKGBUILD_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "PKGBUILD (Русский)").

**Примечание:**

*   Убедитесь, что утилита [sudo](/index.php/Sudo_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "Sudo (Русский)") настроена должным образом для команд, передаваемых [pacman](/index.php/Pacman_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "Pacman (Русский)").
*   Запуск *makepkg* от root-пользователя [запрещён](https://lists.archlinux.org/pipermail/pacman-dev/2014-March/018911.html).[[2]](https://git.archlinux.org/pacman.git/tree/NEWS) Поскольку `PKGBUILD` может содержать произвольные команды, сборка пакетов под root-аккаунтом признана небезопасной.[[3]](https://bbs.archlinux.org/viewtopic.php?id=67561) Если у пользователя нет доступа к обычному пользовательскому аккаунту, то следует запускать *makepkg* от имени пользователя ["nobody"](http://allanmcrae.com/2015/01/replacing-makepkg-asroot/).

Чтобы собрать пакет, первым делом необходимо создать файл [PKGBUILD](/index.php/PKGBUILD_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "PKGBUILD (Русский)"), скрипт сборки, как описано в статье [Создание пакетов](/index.php/%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%BE%D0%B2 "Создание пакетов"). Существующие скрипты доступны в дереве каталогов [Системы сборки Arch](/index.php/Arch_Build_System_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "Arch Build System (Русский)") *(ABS)*, а также в [AUR](/index.php/AUR_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "AUR (Русский)"). После получения `PKGBUILD` переместитесь в его каталог и выполните следующую команду, чтобы собрать пакет:

```
$ makepkg

```

Если необходимые зависимости не установлены, *makepkg* предупредит вас об этом перед тем как отменить сборку. Чтобы собрать пакет и установить все необходимые зависимости, добавьте флаг `-s`/`--syncdeps`:

```
$ makepkg --syncdeps

```

С добавленным флагом `-r`/`--rmdeps` *makepkg* также удалит установленные зависимости для сборки, если они больше будут не нужны. Если вы постоянно занимаетесь сборкой пакетов и не хотите загрязнять систему пакетами-сиротами, то будет также полезно ознакомиться с [удалением неиспользуемых пакетов](/index.php/Pacman_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)/Tips_and_tricks_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)#Удаление_неиспользуемых_пакетов "Pacman (Русский)/Tips and tricks (Русский)").

**Примечание:**

*   Пакеты, устанавливаемые в качестве зависимостей, должны находиться в настроенных репозиториях; детали настроек смотрите в разделе [Pacman (Русский)#Репозитории](/index.php/Pacman_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)#Репозитории "Pacman (Русский)"). Помимо этого, можно установить зависимости вручную перед началом сборки (`pacman -S --asdeps *зависимость1* *зависимость2*`).
*   При установке зависимостей используются только глобальные значения переменных, то есть, к примеру, попытки переопределения значений внутри функции упаковки разделённого пакета (split package) не сработают. [[4]](https://patchwork.archlinux.org/patch/2271/)

Когда все зависимости установлены и сборка пакета завершилась успешно, в рабочем каталоге появится файл пакета (`*имя-пакета*-*версия-пакета*.pkg.tar.xz`). Чтобы установить его в систему, используйте флаг `-i`/`--install` (что идентично команде `pacman -U *имя-пакета*-*версия-пакета*.pkg.tar.xz`):

```
$ makepkg --install

```

Для удаления оставшихся файлов и каталогов, таких как распакованные в `$srcdir` файлы, используйте флаг `-c`/`--clean`. Это полезно в случае многократных сборок одного и того же пакета или обновления его версии, если используется один и тот же рабочий каталог. Это предотвращает добавление устаревших файлов в новые сборки:

```
$ makepkg --clean

```

См. [makepkg(8)](https://www.archlinux.org/pacman/makepkg.8.html) для получения дополнительной информации.

## Советы и рекомендации

### Создание оптимизированных двоичных пакетов

Повышение производительности программного обеспечения может быть достигнуто с помощью оптимизации работы компилятора на этапе сборки пакета. С другой стороны, нужно иметь в виду, что двоичные файлы, скомпилированные под специфическую архитектуру процессора, не будут правильно работать на других машинах. Если говорить об архитектуре x86_64, то редко когда достигнутый эффект повышения производительности стоит затраченного на пересборку официальных пакетов времени.

В то же время нужно помнить, что снизить производительность путём установки "нестандартных" флагов компилятора очень легко. Чаще всего тонкая настройка компилятора приносит пользу лишь в определённой ситуации и не должна применяться ко всем пакетам без разбора. Если вы не можете доказать повышение производительности путем тестов, то скорее всего, её просто нет! Статьи из Gentoo-wiki [Оптимизации GCC](https://wiki.gentoo.org/wiki/GCC_optimization/ru) и [Safe CFLAGS](http://wiki.gentoo.org/wiki/Safe_CFLAGS) содержат больше информации об оптимизации компилятора.

Опции, переданные C/C++ компилятору (например, [gcc](https://www.archlinux.org/packages/?name=gcc) или [clang](https://www.archlinux.org/packages/?name=clang)) зависят от переменных окружения `CFLAGS`, `CXXFLAGS` и `CPPFLAGS`. В [Системе сборки Arch](/index.php/%D0%A1%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%B0_%D1%81%D0%B1%D0%BE%D1%80%D0%BA%D0%B8_Arch "Система сборки Arch") *makepkg* извлекает переменные окружения из файла конфигурации `makepkg.conf` и использует их в качестве опций. Значения по умолчанию выбраны таким образом, чтобы создаваемые двоичные пакеты могли устанавливаться на широким диапазоне машин.

**Примечание:**

*   Следует помнить, что не все системы сборки используют переменные, указанные в `makepkg.conf`. Например, *cmake* пренебрегает переменной опций препроцессора, `CPPFLAGS`. Как следствие, многие файлы [PKGBUILD](/index.php/PKGBUILD_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "PKGBUILD (Русский)") содержат обходные решения, необходимые для системы сборки, используемой для конкретного программного обеспечения.
*   Настройки, указанные в файле `Makefile` или специфический аргумент в команде компиляции имеет приоритет над значениями в `makepkg.conf`, что может привести к их переопределению.

Компилятор GCC может автоматически обнаруживать и включать безопасные оптимизации, доступные для конкретной архитектуры. Чтобы использовать эту особенность, сначала удалите любые `-march` и `-mtune` флаги, а затем добавьте опцию `-march=native`. Например:

 `/etc/makepkg.conf` 
```
CFLAGS="**-march=native** -O2 -pipe -fstack-protector-strong -fno-plt"
CXXFLAGS="${CFLAGS}"
```

Чтобы узнать, какие флаги эта команда разблокирует на вашей машине, выполните:

```
$ gcc -march=native -v -Q --help=target

```

**Примечание:** Если вы укажете значение, отличное от `-march=native`, то `-Q --help=target` не сработает, как должно. [[5]](https://bbs.archlinux.org/viewtopic.php?pid=1616694#p1616694) Вам придётся пройти через фазу компиляции, чтобы узнать, какие опции на самом деле были включены.

### Сокращение времени компиляции

#### Параллельная компиляция

Для сборки пакетов с помощью [make](https://www.archlinux.org/packages/?name=make) используется [переменная окружения](/index.php/Environment_variables_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "Environment variables (Русский)") `MAKEFLAGS`, которая определяет дополнительные опции для утилиты *make*. Установить значение этой переменной можно также в файле `makepkg.conf`.

Пользователи с многоядерными/многопроцессорными системами могут указать количество задач, запускаемых одновременно. Это делается с помощью утилиты для определения количества доступных ядер *nproc*, например `MAKEFLAGS="-j$(nproc)"`. Некоторые файлы [PKGBUILD](/index.php/PKGBUILD_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "PKGBUILD (Русский)") переопределяют это значение на `-j1`, чтобы избежать состояний гонки или просто потому что многопоточная работа не поддерживается изначально. Если сборка пакета завершилась неудачно из-за описанных выше изменений в `MAKEFLAGS`, то нужно создать [отчёт об ошибке](/index.php/Bug_reporting_guidelines_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "Bug reporting guidelines (Русский)") или, в случае пакета из [AUR](/index.php/AUR_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "AUR (Русский)"), сообщить сопроводителю пакета.

Чтобы узнать о других доступных опциях, обратитесь к [make(1)](https://jlk.fjfi.cvut.cz/arch/manpages/man/make.1).

#### Сборка из файлов в памяти

Если компиляция требует много операций ввода-вывода и обработки маленьких файлов, перемещение рабочего каталога во временную файловую систему [tmpfs](/index.php/Tmpfs_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "Tmpfs (Русский)") может сократить время компиляции.

Переменная `BUILDDIR` может быть временно экспортирована в *makepkg*, чтобы установить рабочий каталог в существующий раздел с tmpfs. Например:

```
$ BUILDDIR=/tmp/makepkg makepkg

```

Чтобы сделать эту настройку постоянной, нужно раскомментировать опцию `BUILDDIR` исходного файла настроек `/etc/makepkg.conf`. Если, к примеру, установить это значение `BUILDDIR=/tmp/makepkg`, то будет использоваться обычная временная файловая система Arch `/tmp`.

**Примечание:**

*   Старайтесь не компилировать большие пакеты в tmpfs, чтобы не произошло исчерпания памяти.
*   Каталог tmpfs должен быть смонтирован без опции `noexec`, потому что иначе собранный двоичный пакет будет невозможно исполнить.
*   Также помните, что собранные в tmpfs пакеты будут удалены при перезагрузке. Задайте опцию [PKGDEST](#Параметры_пакета), чтобы собранный пакет автоматически перемещался в "постоянный" каталог.

#### Использование кэша компиляции

Применение [ccache](/index.php/Ccache "Ccache") может уменьшить время сборки за счет многократного использования кэша компиляции.

### Вычисление новых контрольных сумм

Установите пакет [pacman-contrib](https://www.archlinux.org/packages/?name=pacman-contrib) и выполните следующую команду в каталоге с файлом `PKGBUILD`, чтобы сгенерировать новые контрольные суммы:

```
$ updpkgsums

```

Контрольные суммы также можно получить посредством команды `sha256sum`, после чего полученные значения следует добавить к массиву `sha256sums` в файле `PKGBUILD` вручную.

### Применение других алгоритмов сжатия

Создание и установку пакета можно ускорить, заплатив за это увеличением размера. Для этого нужно изменить переменную окружения `PKGEXT`. Например, для создания пакета в виде несжатого архива необходимо выполнить команду:

```
$ PKGEXT='.pkg.tar' makepkg

```

Другой пример, с использованием алгоритма сжатия lzop (необходим пакет [lzop](https://www.archlinux.org/packages/?name=lzop)):

```
$ PKGEXT='.pkg.tar.lzo' makepkg

```

Чтобы сделать одну из этих настроек постоянной, нужно установить соответствующее значение `PKGEXT` в `/etc/makepkg.conf`.

### Использование нескольких ядер при сжатии

[xz](https://www.archlinux.org/packages/?name=xz) поддерживает [симметричную многопроцессорность (SMP)](https://en.wikipedia.org/wiki/ru:%D0%A1%D0%B8%D0%BC%D0%BC%D0%B5%D1%82%D1%80%D0%B8%D1%87%D0%BD%D0%B0%D1%8F_%D0%BC%D0%BD%D0%BE%D0%B3%D0%BE%D0%BF%D1%80%D0%BE%D1%86%D0%B5%D1%81%D1%81%D0%BE%D1%80%D0%BD%D0%BE%D1%81%D1%82%D1%8C "wikipedia:ru:Симметричная многопроцессорность") посредством флага `--threads` для ускорения сжатия. Например, чтобы разрешить *makepkg* использовать все имеющиеся в наличии ядра CPU, отредактируйте массив `COMPRESSXZ` в `/etc/makepkg.conf`:

```
COMPRESSXZ=(xz -c -z - --threads=0)

```

[pigz](https://www.archlinux.org/packages/?name=pigz) — параллельная реализация [gzip](https://www.archlinux.org/packages/?name=gzip), по умолчанию использует все доступные ядра CPU. Если необходимо задействовать меньшее количество ядер, то используется флаг `-p/--processes`:

```
COMPRESSGZ=(pigz -c -f -n)

```

[pbzip2](https://www.archlinux.org/packages/?name=pbzip2) — параллельная реализация [bzip2](https://www.archlinux.org/packages/?name=bzip2), также использует максимально возможное количество ядер по умолчанию. Флаг `-p#` используется для выбора меньшего количества ядер (примечание: между `-p` и числом ядер не должно быть пробелов):

```
COMPRESSBZ2=(pbzip2 -c -f)

```

[zstd](https://www.archlinux.org/packages/?name=zstd) поддерживает [симметричную многопроцессорность (SMP)](https://en.wikipedia.org/wiki/ru:%D0%A1%D0%B8%D0%BC%D0%BC%D0%B5%D1%82%D1%80%D0%B8%D1%87%D0%BD%D0%B0%D1%8F_%D0%BC%D0%BD%D0%BE%D0%B3%D0%BE%D0%BF%D1%80%D0%BE%D1%86%D0%B5%D1%81%D1%81%D0%BE%D1%80%D0%BD%D0%BE%D1%81%D1%82%D1%8C "wikipedia:ru:Симметричная многопроцессорность") посредством флага `--threads` для ускорения сжатия. Например, чтобы разрешить *makepkg* использовать все имеющиеся в наличии ядра CPU, отредактируйте массив `COMPRESSXZ` в `/etc/makepkg.conf`:

```
COMPRESSXZ=(zstd -c -z -q - --threads=0)

```

### Вывод списка пакетов по имени создателя

Если необходимо вывести список всех установленных пакетов, создателем которых является *создатель-пакета*, выполните:

```
$ expac "%n %p" | grep "*создатель-пакета*" | column -t

```

Для вывода списка пакетов, создатель которых указан в переменной `PACKAGER` файла `/etc/makepkg.conf` (покажет только пакеты из репозиториев, определенных в `/etc/pacman.conf`):

```
$ . /etc/makepkg.conf; grep -xvFf <(pacman -Qqm) <(expac "%n\t%p" | grep "$PACKAGER$" | cut -f1)

```

### Сборка 32-битных пакетов в 64-битной системе

**Важно:** Если вы попытаетесь собрать пакет [linux](https://www.archlinux.org/packages/?name=linux) указанным ниже способом, результатом будет сообщение об ошибке.

Предварительно разблокируйте репозиторий [multilib](/index.php/Multilib_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "Multilib (Русский)") и [установите](/index.php/%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0 "Установка") группу пакетов [multilib-devel](https://www.archlinux.org/groups/x86_64/multilib-devel/).

Затем создайте 32-битный файл настроек

 `~/.makepkg.i686.conf` 
```
CARCH="i686"
CHOST="i686-unknown-linux-gnu"
CFLAGS="-m32 -march=i686 -mtune=generic -O2 -pipe -fstack-protector-strong"
CXXFLAGS="${CFLAGS}"
LDFLAGS="-m32 -Wl,-O1,--sort-common,--as-needed,-z,relro"
```

и выполните *makepkg* следующим образом:

```
$ linux32 makepkg --config ~/.makepkg.i686.conf

```

## Решение проблем

### CFLAGS/CXXFLAGS/LDFLAGS в makepkg.conf не работают для пакетов на основе CMake

Чтобы CMake мог применить значения переменных, определенных в `makepkg.conf`, просто не используйте флаг `-DCMAKE_BUILD_TYPE` в процессе настройки проекта cmake. [[6]](https://lists.archlinux.org/pipermail/arch-dev-public/2018-March/029181.html)

В результате CMake применит тип сборки `None`, что позволит использовать переменные окружения `CFLAGS`, `CPPFLAGS` и т.д.

### CFLAGS/CXXFLAGS/LDFLAGS в makepkg.conf не работают для пакетов на основе QMake

Qmake автоматически устанавливает переменные `CFLAGS`, `CXXFLAGS` and `LDFLAGS`, руководствуясь своими внутренними настройками. Если необходимо, чтобы Qmake использовал значения из `makepkg.conf`, нужно отредактировать `PKGBUILD` и передать Qmake переменные [QMAKE_CFLAGS](https://doc.qt.io/qt-5/qmake-variable-reference.html#qmake-cflags), [QMAKE_CXXFLAGS](https://doc.qt.io/qt-5/qmake-variable-reference.html#qmake-cxxflags) and [QMAKE_LFLAGS](https://doc.qt.io/qt-5/qmake-variable-reference.html#qmake-lflags). Например:

 `PKGBUILD` 
```
...

build() {
  cd "$srcdir/$_pkgname-$pkgver-src"
  qmake-qt5 "$srcdir/$_pkgname-$pkgver-src/$_pkgname.pro" \
    PREFIX=/usr \
    QMAKE_CFLAGS="${CFLAGS}" \
    QMAKE_CXXFLAGS="${CXXFLAGS}" \
    QMAKE_LFLAGS="${LDFLAGS}"

  make
}

...

```

В качестве альтернативы можно создать файл системных настроек `qmake.conf` и установить переменную окружения [QMAKESPEC](https://doc.qt.io/qt-5/qmake-environment-reference.html#qmakespec).

### Назначение установочного каталога для пакетов на основе QMAKE

Генерируемый Qmake файл `makefile` использует переменную окружения INSTALL_ROOT чтобы указать, куда программа должна быть установлена. Например, в функции *package*:

 `PKGBUILD` 
```
...

package() {
	cd "$srcdir/${pkgname%-git}"
	make INSTALL_ROOT="$pkgdir" install
}

...

```

Обратите внимание, что Qmake тоже должен быть соответствующим образом сконфигурирован. К примеру, добавьте следующие строки в ваш `.pro` файл.

 `YourProject.pro` 
```
...

target.path = /usr/local/bin
INSTALLS += target

...

```

### WARNING: Package contains reference to $srcdir

Подобное предупреждение означает, что строковый литерал, указанный в переменных `$srcdir` или `$pkgdir`, каким-то образом оказался в одном или нескольких файлах вашего пакета [[7]](http://www.mail-archive.com/arch-general@archlinux.org/msg15561.html).

Чтобы определить, в каких именно файлах, выполните следующую команду в рабочем каталоге сборки:

```
$ grep -R "$(pwd)/src" pkg/

```

Одной из причин появления этого предупреждения может быть использованный в коде C/C++ макрос `__FILE__`, содержащий полный путь к каталогу `$srcdir`.

### Makepkg не может загрузить зависимости через прокси

Когда *makepkg* проверяет зависимости, он вызывает [pacman](/index.php/Pacman_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "Pacman (Русский)") для установки пакетов, который требует предоставления прав администратора посредством *sudo*. Однако команда *sudo* не передает никакие переменные окружения в привилегированное окружение, в том числе и относящиеся к настройкам прокси переменные `ftp_proxy`, `http_proxy`, `https_proxy` и `no_proxy`.

Чтобы *makepkg* мог работать через прокси, воспользуйтесь одним из советов ниже.

#### Установите URL прокси-сервера в XferCommand

XferCommand можно настроить для использования указанного в `/etc/pacman.conf` URL прокси. Добавьте или раскомментируйте следующую строку:

 `/etc/pacman.conf` 
```
...
XferCommand = /usr/bin/curl -x http://username:password@proxy.proxyhost.com:80 -L -C - -f -o %o %u
...

```

#### Разблокируйте прокси в файле /etc/sudoers

Опция `env_keep` в файле `/etc/sudoers` позволяет использовать упомянутые выше прокси-переменные в привилегированном окружении. За подробной информацией обратитесь к [Sudo (Русский)#Переменные окружения](/index.php/Sudo_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)#Переменные_окружения "Sudo (Русский)").

### Makepkg не работает, но make завершается успешно

Если пакет компилируется вручную с помощью *make*, но не посредством *makepkg*, причиной могут быть переменные компиляции в файле `/etc/makepkg.conf`. Попробуйте добавить следующие флаги к массиву `options` файла `PKGBUILD`:

`!buildflags`, для отключения значений по умолчанию `CPPFLAGS`, `CFLAGS`, `CXXFLAGS`, и `LDFLAGS`.

`!makeflags`, для отключения `MAKEFLAGS`, если вы меняли `/etc/makepkg.conf` чтобы разрешить параллельную сборку.

`!debug`, для отключения `DEBUG_CFLAGS` и `DEBUG_CXXFLAGS`, если вы собрали пакет для дебага.

Если что-то из перечисленного выше решило проблему, выясните, какой именно флаг создавал проблему и сообщите о баге разработчикам.

## Смотрите также

*   [Справочная страница makepkg(8)](https://www.archlinux.org/pacman/makepkg.8.html)
*   [Справочная страница makepkg.conf(5)](https://www.archlinux.org/pacman/makepkg.conf.5.html)
*   [Краткое описание работы makepkg](https://gist.github.com/Earnestly/bebad057f40a662b5cc3)
*   [Исходный код makepkg](https://projects.archlinux.org/pacman.git/tree/scripts/makepkg.sh.in)