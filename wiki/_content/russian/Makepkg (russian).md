Ссылки по теме

*   [Создание пакетов](/index.php/%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%BE%D0%B2 "Создание пакетов")
*   [PKGBUILD (Русский)](/index.php/PKGBUILD_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "PKGBUILD (Русский)")
*   [.SRCINFO](/index.php/.SRCINFO ".SRCINFO")
*   [Пользовательский репозиторий Arch](/index.php/%D0%9F%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8C%D1%81%D0%BA%D0%B8%D0%B9_%D1%80%D0%B5%D0%BF%D0%BE%D0%B7%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%B9_Arch "Пользовательский репозиторий Arch")
*   [pacman (Русский)](/index.php/Pacman_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "Pacman (Русский)")
*   [Официальные репозитории](/index.php/%D0%9E%D1%84%D0%B8%D1%86%D0%B8%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5_%D1%80%D0%B5%D0%BF%D0%BE%D0%B7%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%B8 "Официальные репозитории")
*   [Система сборки Arch](/index.php/%D0%A1%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%B0_%D1%81%D0%B1%D0%BE%D1%80%D0%BA%D0%B8_Arch "Система сборки Arch")

[makepkg](https://projects.archlinux.org/pacman.git/tree/scripts/makepkg.sh.in) — базовая утилита для сборки собственных пакетов, которые могут быть использованы менеджером **pacman**. Основанный на скриптовой системе сборки пакетов, makepkg способен загрузить из интернета и проверить на целостность исходники (например архивы tar.gz и bz2), установить параметры сборки пакета (т.к флаги CFLAGS и другие параметры компилятора), собрать пакет во временную папку и создать готовый архив соответствующий стандарту Arch, удалив все ненужное.

<input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none">

## Contents

<label class="toctogglelabel" for="toctogglecheckbox"></label>

*   [1 Настройка](#Настройка)
    *   [1.1 Информация о создателе пакета](#Информация_о_создателе_пакета)
    *   [1.2 Параметры пакета](#Параметры_пакета)
    *   [1.3 Проверка сигнатур](#Проверка_сигнатур)
*   [2 Makepkg](#Makepkg)
*   [3 Сборка пакета](#Сборка_пакета)
    *   [3.1 Настройка: архитектура и флаги компиляции](#Настройка:_архитектура_и_флаги_компиляции)
        *   [3.1.1 Опция MAKEFLAGS](#Опция_MAKEFLAGS)
*   [4 Установка через скрипты сборки](#Установка_через_скрипты_сборки)
*   [5 Смотрите также](#Смотрите_также)

## Настройка

Чтобы больше узнать о возможных опциях настройки *makepkg* обратитесь к [makepkg.conf(5)](https://jlk.fjfi.cvut.cz/arch/manpages/man/makepkg.conf.5).

Общесистемные настройки доступны в `/etc/makepkg.conf`, пользовательские - в `$XDG_CONFIG_HOME/pacman/makepkg.conf` или `~/.makepkg.conf`. Перед сборкой пакета рекомендуется проверять настройки.

### Информация о создателе пакета

Каждый пакет обладает метаданными, в которых помимо прочего содержится информация о создателе пакета. Если этот параметр не задан, то при создании пакета ему присваивается значение по умолчанию `Unknown Packager`. Однако если несколько пользователей занимаются компиляцией пакетов на данном компьютере, или вы планируете предложить пакет для установки другим пользователям, то имеет смысл указать настоящие контактные данные. Сделать это можно посредством установки переменной `PACKAGER` в файле `makepkg.conf`.

Проверить эту настройку можно для установленного пакета:

 `$ pacman -Qi *имя-пакета*` 
```
...
Packager       : John Doe <john@doe.com>
...
```

Для автоматического создания подписанных пакетов также необходимо задать в файле `makepkg.conf` переменную `GPGKEY`.

### Параметры пакета

По умолчанию, *makepkg* создает *tarball* пакета в рабочем каталоге, а исходный код загружает в каталог `scr/`. Можно переназначить пути целевых каталогов, например, чтобы все собранные пакеты хранились в `~/build/packages/`, а весь исходный код - в `~/build/sources/`.

Необходимо задать следующие значения в `makepkg.conf`:

*   `PKGDEST` - каталог для итоговых устанавливаемых пакетов (с расширением `.pkg.tar.xz`)
*   `PKGDEST` - каталог для файлов с исходным кодом
*   `SRCPKGDEST` - каталог для пакетов исходного кода (с расширением `.src.tar.gz`)

**Совет:** Каталог `PKGDEST` может быть очищен командой `paccache -c ~/build/packages/`, как описано в [pacman (Русский)#Очистка кэша пакетов](/index.php/Pacman_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)#Очистка_кэша_пакетов "Pacman (Русский)").

### Проверка сигнатур

**Примечание:** Проверка сигнатур, реализованная в *makepkg*, не использует связки ключей *pacman*, а полагается исключительно на пользовательские связки. [[1]](http://allanmcrae.com/2015/01/two-pgp-keyrings-for-package-management-in-arch-linux/)

Если файл сигнатур с расширением *.sig* или *.asc* является частью массива *source*, указанного в файле [PKGBUILD](/index.php/PKGBUILD_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "PKGBUILD (Русский)"), *makepkg* автоматически предпримет попытку [проверить](/index.php/GnuPG#Verify_a_signature "GnuPG") их. Если пользовательская связка ключей не содержит необходимый для подтверждения сигнатур открытый PGP-ключ, то *makepkg* прервет установку, выведя сообщение "Нет возможности проверить PGP-ключ" ("PGP key could not be verified").

Если необходимый открытый ключ отсутствует, то `PKGBUILD` скорее всего содержит пункт [PKGBUILD#validpgpkeys](/index.php/PKGBUILD#validpgpkeys "PKGBUILD") с необходимыми ID ключей. Ключи можно [импортировать](/index.php/GnuPG_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)#Импортирование_ключей "GnuPG (Русский)") вручную, или же найти [на сервере ключей](/index.php/GnuPG#Use_a_keyserver "GnuPG") и импортировать оттуда.

## Makepkg

Если вы хотите иметь возможность устанавливать недостающие для сборки пакета зависимости, установите утилиту **sudo** и добавьте вашего пользователя в файл настройки утилиты: **/etc/sudoers**.

*ЗАМЕТКА:* в состав пакета sudo входит утилита **visudo** которая запускает редактор **vi** в особом режиме, позволяющем сразу-же отредактировать файл без изменения прав доступа.

```
USER_NAME    ALL=(ALL)    NOPASSWD: /usr/bin/pacman

```

Добавив эту строку и заменив USER_NAME именем вашего пользователя, у вас появится возможность запускать pacman без необходимости ввода пароля.

Следующий шаг - это определения папки в которой будут перемещены "свежесобранные" пакеты, например вы можете назначить здесь папку в вашем домашнем каталоге. Если этот параметр не был установлен, то пакеты будут расположены в той-же папке откуда был запущен makepkg.

Например, создайте такую папку:

```
$ mkdir /home/$USER/packages

```

и установите переменную **PKGDEST** в файле **/etc/makepkg.conf** соотвествующим образом.

Пока вы редактируете его, можете посмотреть на другие переменные влияющие на сборку ваших пакетов. Например вы можете установить переменную **PACKAGER**, при этом ваше имя будет добавлено к собранным пакетам, либо убрать **!** перед параметром **docs** в массиве **OPTIONS**, в случае если вы не хотите чтобы makepkg удалял папку с документацией к вашему пакету. Просмотрите статью [Makepkg.conf](/index.php/Makepkg.conf "Makepkg.conf") для подробной информации по возможным параметрам.

## Сборка пакета

Для сборки пакета вы можете создать собственный "с нуля" следуя указаниям [Руководства по сборке пакетов Arch](/index.php/Creating_packages_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "Creating packages (Русский)"), либо, если кто-то уже сделал это за вас, поискать на странице [AUR](https://aur.archlinux.org/) или в дереве [ABS](/index.php/ABS "ABS").

Например, вы нашли какой-то очень интересующий вас пакет в AUR и хотите собрать его и установить (в этом примере будет приведен **rufus**, клиент bittorrent основанный на Python). Вы можете достать **PKGBUILD** и все необходимые для сборки файлы (в некоторых случаях это патчи или дополнительные скрипты) нажав на ссылку "Tarball" или "Архив", для пользователей просматривающих страницу на русском языке.

```
$ cd /path/to/tarball
$ tar -zxf rufus.tar.gz
$ cd rufus

```

Обратите внимание на то, что в папке rufus появились несколько файлов, один из них называется PKGBUILD, именно он и содержит инструкции для сборки пакета. Для сборки пакета введите (под управлением вашего пользователя) команду:

```
$ makepkg

```

Утилита загрузит все необходимые для сборки исходники и попытается собрать пакет. Если не хватает каких-то зависимостей, makepkg сообщит об этом прежде чем завершить работу с ошибкой. Если вы хотите собрать пакет и дать возможность makepkg самому загрузить и установить необходимые зависимости, то введите эту команду:

```
$ makepkg -s

```

Обратите внимание, что зависимости должны быть доступны в заранее настроенных вами репозитариях. С другой стороны, вы можете собственноручно установить их командой

```
$ sudo pacman -S dep1 dep2 depN

```

После того как все необходимые зависимости были установлены и ваш пакет был собран удачно, у вас появится файл **rufus-0.7.0-1.pkg.tar.gz**. Вы можете установить его командой

```
$ sudo pacman -U rufus-0.7.0-1.pkg.tar.gz

```

### Настройка: архитектура и флаги компиляции

Основные настройки makepkg находятся в файле `/etc/makepkg.conf`.

Опции `MAKEFLAGS`, `CFLAGS` и `CXXFLAGS` используются программами [make](https://www.archlinux.org/packages/?name=make), [gcc](https://www.archlinux.org/packages/?name=gcc) и `g++` во время компиляции программ через makepkg. По умолчанию, эти опции направлена на генерацию «обычных» (generic) пакетов, которые могут устанавливаться и работать на различных аппаратных конфигурациях. Тонкой настройкой опций компиляции может быть достигнут прирост производительности на конкретной машине. Но пакет, скомпилированный под конкретный процессор, может не работать на других машинах.

**Примечание:** Не все пакеты и/или системы сборки пакетов будут использовать эти опции компиляции. Иногда опции задаются жёстко в настройках оригинальных Makefiles или в [PKGBUILD](/index.php/PKGBUILD_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "PKGBUILD (Русский)").
 `/etc/makepkg.conf` 
```
...

#########################################################################
# ARCHITECTURE, COMPILE FLAGS
#########################################################################
#
CARCH="x86_64"
CHOST="x86_64-unknown-linux-gnu"

#-- Exclusive: will only run on x86_64
# -march (or -mcpu) builds exclusively for an architecture
# -mtune optimizes for an architecture, but builds for whole processor family
CFLAGS="-march=x86-64 -mtune=generic -O2 -pipe -fstack-protector --param=ssp-buffer-size=4 -D_FORTIFY_SOURCE=2"
CXXFLAGS="-march=x86-64 -mtune=generic -O2 -pipe -fstack-protector --param=ssp-buffer-size=4 -D_FORTIFY_SOURCE=2"
LDFLAGS="-Wl,-O1,--sort-common,--as-needed,-z,relro"
#-- Make Flags: change this for DistCC/SMP systems
#MAKEFLAGS="-j2"

...

```

Изначальные опции `CFLAGS` and `CXXFLAGS` файла makepkg.conf совместимы с любой машиной соответствующей архитектуры.

Начиная с версии 4.3.0, GCC содержит настройку `-march=native`, которая включает автонастройку под конкретный процессор и автоматически включает соответствующие оптимизации при сборке. Чтобы использовать эту настройку, измените начальные опции `CFLAGS` и `CXXFLAGS` следующим образом:

```
# -march=native also sets the correct -mtune=
CFLAGS="-march=native -O2 -pipe -fstack-protector --param=ssp-buffer-size=4 -D_FORTIFY_SOURCE=2"
CXXFLAGS="${CFLAGS}"

```

Посмотрите [gcc(1)](https://jlk.fjfi.cvut.cz/arch/manpages/man/gcc.1) для полного списка доступных опций. Дополнительную информацию можно найти в вики проекта Gentoo: [Compilation Optimization Guide](http://www.gentoo.org/doc/en/gcc-optimization.xml) и [Safe Cflags](http://wiki.gentoo.org/wiki/Safe_CFLAGS).

#### Опция MAKEFLAGS

Опция `MAKEFLAGS` используется для дополнительной настройки процесса сборки. Владельцы многоядерных или многопроцессорных систем могут определить количество одновременных потоков компиляции. Для того чтобы узнать количество доступных процессоров, выполните команду `nproc`. Например, если вывод команды `nproc` будет 4, то при компиляции используйте `-j4`. Некоторые [PKGBUILD](/index.php/PKGBUILD_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "PKGBUILD (Русский)")'ы специально обходят эту настройку своей опцией `-j1` из-за ограничений конкретной программы, или просто потому, что изначально эта опция не поддерживалась, а впоследствии её забыли убрать. Иногда из-за этого сборка может кончиться неудачей, пожалуйста, [сообщайте](/index.php/Reporting_bug_guidelines_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "Reporting bug guidelines (Русский)") о таких случаях на баг-трекер, но сначала убедитесь, что дело именно в использовании ваших MAKEFLAGS.

Смотрите [make(1)](https://jlk.fjfi.cvut.cz/arch/manpages/man/make.1) для полного списка доступных опций.

## Установка через скрипты сборки

Иногда со сторонних репозитариев вы можете обнаружить только файлы типа *.pkgbuild. В этом случае добавьте параметр **-p** к makepkg указав имя нужного вам сборочного скрипта:

```
$ makepkg -p <buildscript>

```

Поздравляем! Теперь вы успешно собрали и установили ваш собственный пакет!

## Смотрите также

*   [Полезное руководство по makepkg/ABS](https://bbs.archlinux.org/viewtopic.php?t=1590)
*   [Руководство по созданию пакетов Arch](/index.php/Creating_packages_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "Creating packages (Русский)")
*   [AUR](https://aur.archlinux.org)
*   [Страница man для makepkg](https://www.archlinux.org/pacman/makepkg.8.html)
*   [Напутствия по созданию PKGBUILD-скриптов в Arch CVS & SVN](/index.php/Arch_CVS_%26_SVN_PKGBUILD_guidelines "Arch CVS & SVN PKGBUILD guidelines")
*   [Makepkg.conf](/index.php/Makepkg.conf "Makepkg.conf")